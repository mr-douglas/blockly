<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Generate Python Programs with Blockly</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

    <!-- TODO: Make the next six local -->
    <link rel=stylesheet href="https://codemirror.net/lib/codemirror.css">
    <link rel=stylesheet href="https://codemirror.net/theme/cobalt.css">
    <script src="https://codemirror.net/lib/codemirror.js"></script>
    <script src="https://codemirror.net/mode/python/python.js"></script>
    <script src="http://www.skulpt.org/js/skulpt.min.js" type="text/javascript"></script> 
    <script src="http://www.skulpt.org/js/skulpt-stdlib.js" type="text/javascript"></script> 
    
    <script src="https://kit.fontawesome.com/7943986573.js" crossorigin="anonymous"></script>
    <script src="blockly_uncompressed.js"></script>
    <script src="generators/python.js"></script>
    <script src="generators/python/colour.js"></script>
    <script src="generators/python/custom_code.js"></script>
    <script src="generators/python/data_types.js"></script>
    <script src="generators/python/ev3.js"></script>
    <script src="generators/python/lists.js"></script>
    <script src="generators/python/logic.js"></script>
    <script src="generators/python/loops.js"></script>
    <script src="generators/python/math.js"></script>
    <script src="generators/python/procedures.js"></script>
    <script src="generators/python/rpi.js"></script>
    <script src="generators/python/text.js"></script>
    <script src="generators/python/time.js"></script>
    <script src="generators/python/turtle.js"></script>
    <script src="generators/python/variables.js"></script>
    <script src="generators/python/variables_dynamic.js"></script>
    <script src="blocks/colour.js"></script>
    <script src="blocks/custom_code.js"></script>
    <script src="blocks/data_types.js"></script>
    <script src="blocks/ev3.js"></script>
    <script src="blocks/lists.js"></script>
    <script src="blocks/logic.js"></script>
    <script src="blocks/loops.js"></script>
    <script src="blocks/math.js"></script>
    <script src="blocks/procedures.js"></script>
    <script src="blocks/rpi.js"></script>
    <script src="blocks/time.js"></script>
    <script src="blocks/text.js"></script>
    <script src="blocks/turtle.js"></script>
    <script src="blocks/variables.js"></script>
    <script src="blocks/variables_dynamic.js"></script>
    <script src="msg/js/en.js"></script>
    <script>
      //For Blockly
      Blockly.HSV_SATURATION = 0.9;
      Blockly.HSV_VALUE = 0.7;
      
      var workspace;
      var codeMirrorEditor;
      var lastPythonFileName = "my_python_program"
      var lastBlocklyFileName = "my_blockly_program"
      //For Skulpt
      var requiredConsoleText = "";
      
      //Blockly Functions
      function updatePython() {
        if (workspace!=null)
        {
          codeMirrorEditor.setValue(Blockly.Python.workspaceToCode(workspace));
        }
      }
      
      
      function copyToClipboard() {
        var tempInput = document.createElement("textarea");
        generatedPython = Blockly.Python.workspaceToCode(workspace);
        tempInput.value = generatedPython;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        document.getElementById("copied-alert").className = "alert";
        window.setTimeout(function() {document.getElementById("copied-alert").className = "hidden";}, 2000);
      }
      
      function saveToFile(contents, extension) {
        var lastFileName = "";
        if (extension=='.py'){
            lastFileName = lastPythonFileName;
          }
          else if (extension=='.blockly'){
            lastFileName = lastBlocklyFileName;
          }
        var fileNameToSaveAs = prompt("Enter a file name for your Python file", lastFileName);
        if (fileNameToSaveAs){
          if (extension=='.py'){
            lastPythonFileName = fileNameToSaveAs;
          }
          else if (extension=='.blockly'){
            lastBlocklyFileName = fileNameToSaveAs;
          }
          fileNameToSaveAs += extension;
          var textFileAsBlob = new Blob([ contents ], { type: 'text/plain' })
          var downloadLink = document.createElement("a");
          downloadLink.download = fileNameToSaveAs;
          downloadLink.innerHTML = "Download File";
          if (window.webkitURL != null) {
            // Chrome allows the link to be clicked without actually adding it to the DOM.
            downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
          } else {
            // Firefox requires the link to be added to the DOM before it can be clicked.
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
          }
          downloadLink.click();
          if (downloadLink.parentElement!=null){
            document.body.removeChild(downloadLink);
          }
        }
      }
      
      //Skulpt Functions
      function outf(text) { 
        var consoleTextArea = document.getElementById("skulpt-console"); 
        consoleTextArea.value = consoleTextArea.value + text;
        requiredConsoleText = consoleTextArea.value;
      }
      
      function inputf() {
        consoleTextArea = document.getElementById("skulpt-console")
        consoleTextArea.readOnly = false;
        requiredConsoleText = consoleTextArea.value;
        var inputText = "This shouldn't appear!";
        inputText = new Promise(
                                  function (resolve, reject){
                                                             document.getElementById("skulpt-console").addEventListener("keyup", 
                                                                                                                                function consoleEnterListener(event){
                                                                                                                                  if(event.keyCode == 13){
                                                                                                                                    consoleTextArea = document.getElementById("skulpt-console")
                                                                                                                                    consoleTextArea.removeEventListener("keyup", consoleEnterListener);
                                                                                                                                    consoleTextArea.readOnly = true;
                                                                                                                                    resolve(consoleTextArea.value.substring(requiredConsoleText.length,consoleTextArea.value.length));
                                                                                                                                  }
                                                                                                                                }
                                                                                                                      );
                                                            }
                               );
        return inputText;
      }
      
      function builtinRead(x) {
        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
          throw "File not found: '" + x + "'";
        return Sk.builtinFiles["files"][x];
      }

      function runPython() {
        var unrunnableStrings = [
                                 'from pybricks import ev3brick as brick',
                                 "#You've added your own code"
                                ]
        var unrunnable = false;
        var prog = Blockly.Python.workspaceToCode(workspace); 
        for(var i = 0;i < unrunnableStrings.length;i++) {
          unrunnable = unrunnable || prog.includes(unrunnableStrings[i]);
        }
        if(unrunnable) {
          alert("Sadly, you won't be able to run that here. You'll need to copy or download the Python code.");
        }
        else
        {
          var needsConsole = prog.includes("#This program uses console I/O");
          var needsTurtle = prog.includes("import turtle");
          if (needsConsole && needsTurtle) {
            document.getElementById("skulpt-console").className = "both";
            document.getElementById("skulpt-canvas").className = "both";
          }
          else if(needsConsole){
            document.getElementById("skulpt-console").className = "console-only";
            document.getElementById("skulpt-canvas").className = "console-only";
          } else {
            document.getElementById("skulpt-console").className = "turtle-only";
            document.getElementById("skulpt-canvas").className = "turtle-only";
          }
          if (needsConsole || needsTurtle){
            document.getElementById("skulpt-container").className = "";
            document.getElementById("excluder").className = "";
          } else {
            alert("Your program won't produce any output");
          }
          var consoleTextArea = document.getElementById("skulpt-console");
          consoleTextArea.value = "";
          Sk.pre = "skulpt-console";
          Sk.configure({inputfun: inputf,                                           
                        output:outf,
                        read:builtinRead}); 
          (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'skulpt-canvas';
          var myPromise = Sk.misceval.asyncToPromise(function() {
            return Sk.importMainWithBody("<stdin>", false, prog, true);
          });
          myPromise.then(function(mod) {
            console.log('success');
          },
            function(err) {
            outf(err.toString());
            alert(err.toString());
            console.log(err.toString());
          });
          consoleTextArea.focus();
        }
      }
    </script>
    <style>
      :root {
        --run-color: forestgreen;
        --load-color: darkgoldenrod;
        --save-color: indianred;
        --copy-color: forestgreen;
      }
    
      body
      {
        overflow: hidden;
      }
    
      #python-container button, #copied-alert, a.my-button
      {
        font-family: 'Varela Round', Arial, sans-serif !important;
      }
      
      #python-container
      {
        float: right;
        height: 100vh;
        width: 25vw;
      }
      
      #python-div
      {
        height: 100%;
        background-color: #222;
        color: lightgreen;      
        font-family: monospace;
        font-weight: bold;
        width: inherit;
        resize: none;
        white-space: pre;
        border: none;
        padding: 0px;
      }
      
      #blocklyDiv
      {
        height: calc(100vh - 17px);
        width: 75%;
      }
      
      .CodeMirror
      {
        height: calc(100vh - 17px);
      }
      
      @keyframes alert {
        0% {opacity: 0;}
        1% {opacity: 1;}
        60% {opacity: 1;}
        100% {opacity: 0;}
      }
      
      a.my-button, #copied-alert
      {
        position: absolute;
        z-index: 100000;
        border-style: solid;
        border-width: 5px;
        border-radius: 30px;
        height: 33px;
        overflow: hidden;
        transition: 0.3s;
      }
      
      a.my-button
      {
        width: 33px;
        z-index: 100000;
      }
      
      a.my-button:hover, #copied-alert
      {
        width: 20vw;
      }
      
      a.my-button > *, #copied-alert > *
      {
        color: white;
        opacity: 0.7;
      }
      
      a.my-button .icon, #copied-alert .icon
      {
        display: inline-block;
        font-size: 16pt;
        text-align: center;
        width: 35px;
        height: 35px;
        padding-top: 3px;
        border-radius: 33px;
        border-width: 5px;
        position: relative;
        top: -2px;
        left: -1px;
      }
      
      a.my-button .icon i, #copied-alert .icon i
      {
        position: relative;
        top: 3px;
      }
      
      a.my-button .text, #copied-alert .text
      {
        font-size: 14pt;
      }
      
      #load-blocks-button, #save-blocks-button, #run-blocks-button
      {
        right: calc(25vw + 10px);
      }
      
      #save-python-button, #copy-python-button, #copied-alert
      {
        right: 10px;
      }
      
      #save-python-button, #save-blocks-button
      {
        border-color: var(--save-color);
        background-color: var(--save-color);
      }
      
      #run-blocks-button
      {
        border-color: var(--run-color);
        background-color: var(--run-color);
        top: 10px;
      }
      
      #run-blocks-button .icon i
      {
        top: 4px;
        left: 1px;
      }
      
      #load-blocks-button
      {
        border-color: var(--load-color);
        background-color: var(--load-color);
        top: 55px;
      }
      
      #save-blocks-button
      {
        top: 100px;
      }
      
      #save-python-button
      {
        bottom: 12px;
      }
        
      #copy-python-button, #copied-alert
      {
        border-color: var(--copy-color);
        background-color: var(--copy-color);
        bottom: 57px;
      }
      
      #copied-alert
      {
        z-index: 100001;
        text-align: center;
        margin: 0px;
        box-shadow: 0px  0px 3px 1px var(--copy-color);  
      }
      
      .hidden
      {
        opacity: 0;
        display: none;
      }
      
      .alert
      {
        display: block;
        animation-name: alert;
        animation-duration: 2s;
        animation-iteration-count: 1;
      }
      
      #excluder
      {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100vw;
        height: 100vh;
        background-color: black;
        opacity: 0.5;
        z-index: 100002;
        transition: 0.3s;
      }
      
      #skulpt-container
      {
        position: absolute;
        z-index: 100003;
        transition: 0.3s;
        background-color: white;
        width: 80vw;
        left: 10vw;
        height: 80vh;
        top: 10vh;
        border-radius: 30px;
      }
      
      #skulpt-close-button
      {
        top: 10px;
        right: 10px;
        font-size: 43px;
        color: var(--save-color);
        background-color: var(--save-color);
        padding: 0px;
        margin: 0px;
      }
      
      #skulpt-close-button:hover
      {
        width: 80pt;
      }
      
      #skulpt-close-button .icon
      {
        font-size: 19pt;
        top: -16px;
      }
      
      #skulpt-close-button .text
      {
        position: relative;
        top: -16px;
      }
      
      #skulpt-console
      {
        resize: none;
        position: fixed;
        height: 70vh;
        top: 15vh;
        left: 15vw;
      }
      
      #skulpt-console.both
      {
        width: 30vw;
      }
      
      #skulpt-console.console-only
      {
        width: 70vw;
      }
      
      #skulpt-console.turtle-only
      {
        display: none;
      }
      
      #skulpt-canvas
      {
        position: fixed;
        width: 400px;
        height: 400px;
        top: calc(50vh - 200px);
        right: calc(30vw - 200px);
        border: solid 1px black;
        border-radius: 4px;
      }
      
      #skulpt-canvas.both
      {
        top: calc(50vh - 200px);
        right: calc(30vw - 200px);
      }
      
      #skulpt-canvas.console-only
      {
        display: none;
      }
      
      #skulpt-canvas.turtle-only
      {
        top: calc(50vh - 200px);
        right: calc(50vw - 200px);
      }
    </style>
  </head>
  <body>
    <xml id="toolbox" style="display: none;">
      <category name="Maths" colour='%{BKY_MATH_HUE}' web-class="myLabelStyle">
        <category name="Basics" colour='%{BKY_MATH_HUE}'>
          <block type="math_number"><field name="NUM">0</field></block>
          <block type="math_arithmetic"><field name="OP">ADD</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
          <block type="math_arithmetic"><field name="OP">MINUS</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
          <block type="math_arithmetic"><field name="OP">MULTIPLY</field><value name="A"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
          <block type="math_arithmetic"><field name="OP">DIVIDE</field><value name="A"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
          <block type="math_arithmetic"><field name="OP">POWER</field><value name="A"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="B"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
          <block type="math_single"><value name="NUM"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
          <block type="math_constant"></block>
        </category>
        <category name="Random" colour='%{BKY_MATH_HUE}'>
          <block type="math_random_int"><value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="TO"><shadow type="math_number"><field name="NUM">100</field></shadow></value></block>
          <block type="math_random_float"></block>
        </category>
        <category name="Trigonometry" colour='%{BKY_MATH_HUE}'>
          <block type="math_trig"><field name="OP">SIN</field> <value name="NUM"><shadow type="math_number"><field name="NUM">45</field></shadow></value></block>
          <block type="math_trig"><field name="OP">COS</field> <value name="NUM"><shadow type="math_number"><field name="NUM">45</field></shadow></value></block>
          <block type="math_trig"> <field name="OP">TAN</field> <value name="NUM"><shadow type="math_number"><field name="NUM">45</field></shadow></value></block>
          <block type="math_inv_trig"><field name="OP">ASIN</field> <value name="NUM"><shadow type="math_constant"><field name="CONSTANT">SQRT1_2</field></shadow></value></block>
          <block type="math_inv_trig"><field name="OP">ACOS</field> <value name="NUM"><shadow type="math_constant"><field name="CONSTANT">SQRT1_2</field></shadow></value></block>
          <block type="math_inv_trig"> <field name="OP">ATAN</field> <value name="NUM"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
        </category>
        <category name="Other" colour='%{BKY_MATH_HUE}'>
          <block type="math_number_property"><value name="NUMBER_TO_CHECK"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>      
          <block type="math_round"><value name="NUM"><shadow type="math_number"><field name="NUM">3.1</field></shadow></value></block>
          <block type="math_on_list"></block>
          <block type="math_modulo"><value name="DIVIDEND"><shadow type="math_number"><field name="NUM">64</field></shadow></value><value name="DIVISOR"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
          <block type="math_constrain"><value name="VALUE"><shadow type="math_number"><field name="NUM">50</field></shadow></value><value name="LOW"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="HIGH"><shadow type="math_number"><field name="NUM">100</field></shadow></value></block>
        </category>
      </category>
      <category colour='%{BKY_TEXTS_HUE}' name="Input/Output">
        <block type="text_print"><value name="TEXT"><shadow type="text"><field name="TEXT">abc</field></shadow></value></block>
        <block type="text_prompt_ext"><value name="TEXT"><shadow type="text"><field name="TEXT">abc</field></shadow></value></block>
        <block type="time_sleep"><value name="SECS"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
      </category>
      <category colour='%{BKY_TEXTS_HUE}' name="Strings (Text)">
        <block type="text"></block>
        <block type="text_join"></block>
        <block type="text_append"><value name="TEXT"><shadow type="text"></shadow></value></block>
        <block type="text_length"><value name="VALUE"><shadow type="text"><field name="TEXT">abc</field></shadow></value></block>
        <block type="text_isEmpty"><value name="VALUE"><shadow type="text"><field name="TEXT"></field></shadow></value></block>
        <block type="text_indexOf"><value name="VALUE"><block type="variables_get"><field name="VAR">text</field></block></value><value name="FIND"><shadow type="text"><field name="TEXT">abc</field></shadow></value></block>
        <block type="text_charAt"><value name="VALUE"><block type="variables_get"><field name="VAR">text</field></block></value></block>
        <block type="text_getSubstring"><value name="STRING"><block type="variables_get"><field name="VAR">text</field></block></value></block>
        <block type="text_changeCase"><value name="TEXT"><shadow type="text"><field name="TEXT">abc</field></shadow></value></block>
        <block type="text_trim"><value name="TEXT"><shadow type="text"><field name="TEXT">abc</field></shadow></value></block>
      </category>
      <sep></sep>
      <category name="Selection (If/Else) and Logic" colour='%{BKY_LOGIC_HUE}'>
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
        <block type="logic_null"></block>
      </category>
      <category name="Iteration (Loops)" colour='%{BKY_LOOPS_HUE}'>
        <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
        <block type="controls_whileUntil"></block>
        <block type="controls_for"><value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value><value name="BY"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
        <block type="controls_forEach"></block>
        <block type="controls_flow_statements"></block>
      </category>
      <category  name="Data Types" colour='%{BKY_VARIABLES_HUE}'>
        <block type="float"></block>
        <block type="int"></block>
        <block type="str"></block>
      </category>
      <sep></sep>
      <category colour='%{BKY_LISTS_HUE}' name="Lists">
        <block type="lists_create_with"><mutation items="0"></mutation></block>
        <block type="lists_create_with"></block>
        <block type="lists_repeat"><value name="NUM"><shadow type="math_number"><field name="NUM">5</field></shadow></value></block>
        <block type="lists_length"></block>
        <block type="lists_isEmpty"></block>
        <block type="lists_indexOf"><value name="VALUE"><block type="variables_get"><field name="VAR">list</field></block></value></block>
        <block type="lists_getIndex"><value name="VALUE"><block type="variables_get"><field name="VAR">list</field></block></value></block>
        <block type="lists_setIndex"><value name="LIST"><block type="variables_get"><field name="VAR">list</field></block></value></block>
        <block type="lists_getSublist"><value name="LIST"><block type="variables_get"><field name="VAR">list</field></block></value></block>
        <block type="lists_split"><value name="DELIM"><shadow type="text"><field name="TEXT">,</field></shadow></value></block>
        <block type="lists_sort"></block>
      </category>
      <category colour='%{BKY_VARIABLES_HUE}' custom="VARIABLE" name="Variables"></category>
      <category colour='%{BKY_PROCEDURES_HUE}' custom="PROCEDURE" name="Functions"></category>
      <sep></sep>
      <category name="Turtle" colour='%{BKY_COLOUR_HUE}'>
        <block type="turtle_move"><value name="DISTANCE"><shadow type="math_number"><field name="NUM">100</field></shadow></value></block>
        <block type="turtle_turn"><value name="ANGLE"><shadow type="math_number"><field name="NUM">45</field></shadow></value></block>
        <block type="turtle_turn_left"></block>
        <block type="turtle_turn_right"></block>
        <block type="turtle_goto"><value name="X"><shadow type="math_number"><field name="NUM">0</field></shadow></value><value name="Y"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
        <block type="turtle_set_speed"></block>
        <block type="turtle_pen_up_down"></block>
        <block type="turtle_pen_colour"></block>
        <block type="turtle_fill_colour"></block>
        <block type="turtle_pen_fill_colour"></block>
        <block type="turtle_begin_fill"></block>
        <block type="turtle_end_fill"></block>
        <block type="turtle_begin_end_fill"></block>
        <block type="turtle_set_pen_size"></block>
        <block type="turtle_set_direction_four"></block>
        <block type="turtle_set_direction_angle"></block>
        <block type="turtle_set_direction"></block>
        <block type="turtle_get_coord"></block>
        <block type="turtle_show"></block>
        <block type="turtle_hide"></block>
        <block type="colour_picker"></block>
        <block type="colour_random"></block>
        <block type="colour_rgb"><value name="RED"><shadow type="math_number"><field name="NUM">100</field></shadow></value><value name="GREEN"><shadow type="math_number"><field name="NUM">50</field></shadow></value><value name="BLUE"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
        <block type="colour_blend"><value name="COLOUR1"><shadow type="colour_picker"><field name="COLOUR">#ff0000</field></shadow></value><value name="COLOUR2"><shadow type="colour_picker"><field name="COLOUR">#3333ff</field></shadow></value><value name="RATIO"><shadow type="math_number"><field name="NUM">0.5</field></shadow></value></block>
      </category>
      <category colour='90' name="EV3">
        <category colour='90' name="Brick">
          <block type="ev3_set_up"></block>
          <block type="ev3_beep"><value name="FREQUENCY"><shadow type="math_number"><field name="NUM">500</field></shadow></value><value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
          <block type="ev3_set_volume"><value name="VOLUME"><shadow type="math_number"><field name="NUM">50</field></shadow></value></block>
          <block type="ev3_color"></block>
          <block type="ev3_brick_light_on"><value name="COLOR"><shadow type="ev3_color"><field name="COLOR">#00cc00</field></shadow></value></block>
          <block type="ev3_brick_light_off"></block>
          <block type="ev3_brick_buttons_pressed"></block>
          <block type="ev3_wait"><value name="TIME"><shadow type="math_number"><field name="NUM">60</field></shadow></value></block>
          <block type="ev3_screen_font"></block>
          <block type="ev3_screen_print"></block>
        </category>
        <category colour='90' name="Motors" custom="EV3_MOTORS"></category>
        <category colour='90' name="Sensors" custom="EV3_SENSORS"></category>
        <block type="ev3_set_up"></block>
        <block type="ev3_color"></block>
      </category>
      <category colour='270' name="Raspberry Pi">
        <label text="Coming Soon!"></label>
      </category>
      <sep></sep>
      <category colour='black' name="Insert Your Own Code">
        <block type="insert_user_code"></block>
      </category>
    </xml>
    <div id="python-container">
      <textarea readonly id="python-div">
      </textarea>
    </div>
    <p id="copied-alert" class="hidden"><span class="icon"><i class="fas fa-copy"></i></span><span class="text"> Copied!</span></p>
    <a id="copy-python-button" class="my-button" onclick="copyToClipboard()"><span class="icon"><i class="fas fa-copy"></i></span><span class="text"> Copy Python to Clipboard</span></a>
    <a id="save-python-button" class="my-button" onclick="saveToFile(Blockly.Python.workspaceToCode(workspace), '.py')"><span class="icon"><i class="fas fa-file-download"></i></span><span class="text"> Save Python Code</span></a>
    <a id="run-blocks-button" class="my-button" onclick="runPython()"><span class="icon"><i class="fas fa-play"></i></span><span class="text"> Run Program</span></a>
    <a id="load-blocks-button" class="my-button" onclick="document.getElementById('inputfile').click()"><span class="icon"><i class="fas fa-file-upload"></i></span><span class="text"> Load Blocks from File</span></a>
    <a id="save-blocks-button" class="my-button" onclick="saveToFile(Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(workspace)), '.blockly')"><span class="icon"><i class="fas fa-file-download"></i></span><span class="text"> Save Blocks to File</span></a>
    <input type="file" name="inputfile" id="inputfile" style="display: none;">
    <div id="excluder" class="hidden">
    </div>
    <div id="skulpt-container" class="hidden">
      <textarea id="skulpt-console" class="both" readonly="true"></textarea> 
      <div id="skulpt-canvas" class="both"></div>
      <a id="skulpt-close-button" class="my-button" onclick="document.getElementById('excluder').className='hidden'; document.getElementById('skulpt-container').className='hidden';"><span class="icon"><i class="fas fa-times"></i></span><span class="text"> Close</span></a>
    </div>
    <div id="blocklyDiv"></div>
    <script>
      document.getElementById('inputfile').addEventListener('change', function() {
                                                                                  var fr=new FileReader();
                                                                                  fr.onload=function(){
                                                                                                       Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(fr.result), workspace);
                                                                                                      }
                                                                                  fr.readAsText(this.files[0]);
                                                                                 }
                                                           );
    
      workspace = Blockly.inject('blocklyDiv',{
                                               toolbox: document.getElementById('toolbox'),
                                               zoom:{controls: true,wheel: true,startScale: 1.0,maxScale: 3,minScale: 0.3,scaleSpeed: 1.025},
                                               grid: {spacing: 20, length: 3, colour: '#222', snap: false},
                                               renderer:'thrasos',
                                               //renderer:'zelos',
                                               trashcan: true
                                              }
                                );
      //TODO: Find out where this should be put, and put it there
      workspace.registerToolboxCategoryCallback('EV3_MOTORS', function(workspace){
                                                                                          var xmlList = [];
                                                                                          xmlList.push(Blockly.Xml.textToDom('<button text="Add New Motor" callbackKey="addMotorButtonPressed"></button>'));
                                                                                          var variableModelList = workspace.getVariablesOfType('EV3Motor');
                                                                                          if(variableModelList.length>0){
                                                                                            xmlList.push(Blockly.Xml.textToDom('<label text="Motors"></label>'));
                                                                                            for (var i = 0, variable; (variable = variableModelList[i]); i++) {
                                                                                              var block = Blockly.utils.xml.createElement('block');
                                                                                              block.setAttribute('type', 'ev3_variables_get_motor');
                                                                                              block.setAttribute('gap', 8);
                                                                                              block.appendChild(Blockly.Variables.generateVariableFieldDom(variable));
                                                                                              xmlList.push(block);
                                                                                            }
                                                                                          }
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_motor_run"><value name="SPEED"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_motor_run_time"><value name="SPEED"><shadow type="math_number"><field name="NUM">90</field></shadow></value><value name="TIME"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_motor_run_angle"><value name="SPEED"><shadow type="math_number"><field name="NUM">90</field></shadow></value><value name="ANGLE"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_motor_run_until_stalled"><value name="SPEED"><shadow type="math_number"><field name="NUM">90</field></shadow></value><value name="DUTY_LIMIT"><shadow type="math_number"><field name="NUM">50</field></shadow></value></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_motor_speed"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_motor_angle"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_motor_reset_angle"><value name="ANGLE"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_motor_stop_brake_hold"></block>'));
                                                                                          return xmlList;
                                                                                         }
                                               );
      workspace.registerToolboxCategoryCallback('EV3_SENSORS', function(workspace){
                                                                                          var xmlList = [];
                                                                                          xmlList.push(Blockly.Xml.textToDom('<button text="Add New Sensor" callbackKey="addSensorButtonPressed"></button>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<label text="These blocks are for setting up the sensors"></label>'));
                                                                                          var variableModelList = workspace.getVariablesOfType('EV3Sensor');
                                                                                          if(variableModelList.length>0){
                                                                                            for (var i = 0, variable; (variable = variableModelList[i]); i++) {
                                                                                              var block = Blockly.utils.xml.createElement('block');
                                                                                              block.setAttribute('type', 'ev3_variables_get_and_set_sensor');
                                                                                              block.setAttribute('gap', 8);
                                                                                              block.appendChild(Blockly.Variables.generateVariableFieldDom(variable));
                                                                                              xmlList.push(block);
                                                                                            }
                                                                                          }
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_touch_sensor"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_colour_sensor"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_ultrasonic_sensor"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_gyro_sensor"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<label text="The rest of the blocks are for use in your program"></label>'));
                                                                                          if(variableModelList.length>0){
                                                                                            for (var i = 0, variable; (variable = variableModelList[i]); i++) {
                                                                                              var block = Blockly.utils.xml.createElement('block');
                                                                                              block.setAttribute('type', 'ev3_variables_get_sensor');
                                                                                              block.setAttribute('gap', 8);
                                                                                              block.appendChild(Blockly.Variables.generateVariableFieldDom(variable));
                                                                                              xmlList.push(block);
                                                                                            }
                                                                                          }
                                                                                          xmlList.push(Blockly.Xml.textToDom('<label text="Color Sensor"></label>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_color_sensor_color"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_color_sensor_ambient"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_color_sensor_reflection"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<label text="Touch Sensor"></label>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_touch_sensor_pressed"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<label text="Ultrasonic Sensor"></label>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_ultrasonic_sensor_distance"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<label text="Gyroscopic Sensor"></label>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_gyro_sensor_speed"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_gyro_angle_speed"></block>'));
                                                                                          xmlList.push(Blockly.Xml.textToDom('<block type="ev3_gyro_sensor_reset_angle"><value name="ANGLE"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>'));
                                                                                          return xmlList;
                                                                                         }
                                               );
      workspace.registerButtonCallback('addMotorButtonPressed', function(button){
                                                                                 Blockly.Variables.createVariableButtonHandler(button.getTargetWorkspace(), null, 'EV3Motor');
                                                                                }
                                      );
      workspace.registerButtonCallback('addSensorButtonPressed', function(button){
                                                                                 Blockly.Variables.createVariableButtonHandler(button.getTargetWorkspace(), null, 'EV3Sensor');
                                                                                }
                                      );

      theme = workspace.getTheme();
      var fontStyle = {
                       "family": "'Varela Round', Arial, sans-serif",
                       "weight": null,
                       "size": null 
                      };
      theme.setFontStyle(fontStyle);
      workspace.setTheme(theme);
      
      pythonTextArea = document.getElementById('python-div')
      var codeMirrorEditor = CodeMirror(function(elt) {
        pythonTextArea.parentNode.replaceChild(elt, document.getElementById('python-div'));
        }, {
          value: "print('Hello, World!')\n",
          mode: "python",
          theme: "cobalt",
          readOnly: true,
          lineNumbers: true
        }
      );
      
      workspace.addChangeListener(updatePython);
      updatePython();
      
      var url = window.location.href;
      if (url.includes('?file=')){
        fetch(url.substring(url.indexOf('?file=')+6))
          .then(response => response.text())
          .then((data) => {
        Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(data), workspace);
        })
      }
    </script>
  </body>
</html>